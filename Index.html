<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 AEC Report - KKV01</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .step-content { display: none; }
        .step-content.active { display: block; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .btn-main { transition: all 0.2s; }
        .btn-main:active { transform: scale(0.95); }
        .gradient-header { background: linear-gradient(135deg, #0f172a 0%, #2563eb 100%); }
        .input-field { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; outline: none; transition: border 0.3s; }
        .input-field:focus { border-color: #3b82f6; ring: 2px; ring-color: #bfdbfe; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); padding: 20px; }
    </style>
</head>
<body class="pb-10">

    <div class="gradient-header text-white p-8 rounded-b-[40px] shadow-xl mb-6 text-center">
        <h1 class="text-3xl font-bold tracking-tighter">2026 AEC REPORT</h1>
        <p class="text-blue-100 text-sm mt-1 opacity-90">Project KKV01 - Field Operation</p>
    </div>

    <div class="max-w-md mx-auto px-4">

        <div id="page-setup" class="step-content active">
            <div class="card">
                <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-user-circle mr-2 text-blue-500"></i>ข้อมูลผู้ใช้งาน</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-gray-500 ml-1">ชื่อเล่น (Name)</label>
                        <input type="text" id="setup-name" class="input-field" placeholder="ระบุชื่อเล่นของคุณ">
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 ml-1">ภาคที่สังกัด (Region)</label>
                        <select id="setup-region" class="input-field">
                            <option value="">เลือกภาค...</option>
                            <option value="BKK">BKK</option><option value="CR">CR</option><option value="ER">ER</option>
                            <option value="NER">NER</option><option value="NR">NR</option><option value="SR">SR</option>
                            <option value="TE">TE</option><option value="DR">DR</option><option value="OFFICE">OFFICE</option>
                        </select>
                    </div>
                    <button onclick="app.saveSetup()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg btn-main">เริ่มใช้งานระบบ</button>
                </div>
            </div>
        </div>

        <div id="page-menu" class="step-content">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="app.goToCheck('Site Check In')" class="card flex flex-col items-center btn-main border-b-4 border-emerald-500">
                    <i class="fas fa-map-location-dot text-3xl text-emerald-500 mb-2"></i>
                    <span class="font-medium">Site Check In</span>
                </button>
                <button onclick="app.goToCheck('Check In')" class="card flex flex-col items-center btn-main border-b-4 border-blue-500">
                    <i class="fas fa-sign-in-alt text-3xl text-blue-500 mb-2"></i>
                    <span class="font-medium">Check In</span>
                </button>
                <button onclick="app.goToCheck('Check Out')" class="card flex flex-col items-center btn-main border-b-4 border-red-500">
                    <i class="fas fa-sign-out-alt text-3xl text-red-500 mb-2"></i>
                    <span class="font-medium">Check Out</span>
                </button>
                <button onclick="app.goToReport()" class="card flex flex-col items-center btn-main border-b-4 border-amber-500">
                    <i class="fas fa-file-signature text-3xl text-amber-500 mb-2"></i>
                    <span class="font-medium">Report</span>
                </button>
                <button onclick="app.goToExpenses()" class="card flex flex-col items-center btn-main border-b-4 border-purple-500">
                    <i class="fas fa-wallet text-3xl text-purple-500 mb-2"></i>
                    <span class="font-medium">Expenses</span>
                </button>
                <button onclick="app.goToCapture()" class="card flex flex-col items-center btn-main border-b-4 border-pink-500">
                    <i class="fas fa-camera-retro text-3xl text-pink-500 mb-2"></i>
                    <span class="font-medium">Capture</span>
                </button>
            </div>
            <div class="mt-6 text-center text-xs text-gray-400">
                Logged in as: <span id="info-name" class="font-bold"></span> (<span id="info-region"></span>)
                <br><button onclick="app.logout()" class="mt-2 text-blue-400 underline">Logout</button>
            </div>
        </div>

        <div id="page-check-form" class="step-content">
            <div class="card">
                <h2 id="check-title" class="text-xl font-bold mb-4 text-gray-800"></h2>
                <div id="check-fields" class="space-y-4">
                    </div>
                
                <div class="mt-4 p-4 border-2 border-dashed rounded-xl text-center bg-gray-50">
                    <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="app.previewImage(this)">
                    <label for="photo-input" class="cursor-pointer">
                        <i class="fas fa-camera text-3xl text-gray-300"></i>
                        <p class="text-sm text-gray-500">ถ่ายภาพ หรือ เลือกรูป</p>
                    </label>
                    <img id="img-preview" class="hidden mt-3 rounded-lg w-full h-48 object-cover">
                </div>

                <div id="gps-box" class="mt-4 p-3 bg-blue-50 rounded-lg text-xs text-blue-700">
                    <i class="fas fa-location-dot mr-1"></i> <span id="gps-status">กรุณากดดึงพิกัด...</span>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button onclick="app.getLocation()" class="flex-1 bg-gray-200 py-3 rounded-xl font-medium">ดึงพิกัด</button>
                    <button id="btn-submit-check" onclick="app.submitCheck()" class="flex-[2] bg-emerald-600 text-white py-3 rounded-xl font-bold hidden">ส่งข้อมูลบันทึก</button>
                </div>
                <button onclick="app.showPage('page-menu')" class="w-full text-gray-400 text-sm mt-4 text-center">ยกเลิก</button>
            </div>
        </div>

        <div id="page-report" class="step-content">
            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-amber-600"><i class="fas fa-file-lines mr-2"></i>Report Work</h2>
                <div class="space-y-4" id="report-container">
                    </div>
                <div id="report-footer" class="mt-6"></div>
            </div>
        </div>

        <div id="page-expenses" class="step-content">
            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-purple-600">จัดการค่าใช้จ่าย</h2>
                <div id="exp-fields" class="space-y-4">
                    </div>
                <button onclick="app.submitExpenses()" class="w-full bg-purple-600 text-white py-4 rounded-xl font-bold mt-6 shadow-lg">บันทึกรูปและส่งค่าใช้จ่าย</button>
            </div>
        </div>

        <div id="page-capture" class="step-content">
            <div class="card mb-4">
                <label class="text-sm font-bold text-gray-600">เลือกวันที่เพื่อเรียกดูรายงาน</label>
                <select id="cap-date-select" class="input-field mt-2" onchange="app.fetchReportData()"></select>
            </div>
            <div id="cap-result" class="space-y-4">
                </div>
            <button onclick="app.showPage('page-menu')" class="w-full bg-gray-800 text-white py-3 rounded-xl mt-6">กลับหน้าหลัก</button>
        </div>

        <div id="page-success" class="step-content text-center">
            <div class="card py-10">
                <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold">บันทึกเรียบร้อย!</h2>
                <p id="success-msg" class="text-gray-500 mt-2 italic">เก่งมาก! ทำงานอย่างมีความสุขนะครับ</p>
                <div id="safety-alert" class="hidden mt-6 p-4 bg-red-100 text-red-700 rounded-xl font-bold border-2 border-red-200 animate-pulse">
                    <i class="fas fa-shield-halved mr-2"></i> SAFETY FIRST! <br> ระมัดระวังความปลอดภัยในการเดินทาง
                </div>
                <button onclick="app.showPage('page-menu')" class="mt-8 bg-blue-600 text-white px-10 py-3 rounded-full font-bold">ไปที่หน้าหลัก</button>
            </div>
        </div>

    </div>

    <script>
        const app = {
            state: {
                user: '', region: '', currentStatus: '',
                lat: '', lng: '', photo: '',
                reportStep: 1, currentJobType: '',
                expData: {}
            },

            showPage(id) {
                document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                window.scrollTo(0, 0);
            },

            saveSetup() {
                const name = document.getElementById('setup-name').value;
                const region = document.getElementById('setup-region').value;
                if(!name || !region) return alert('กรุณากรอกข้อมูลให้ครบ');
                
                this.state.user = name;
                this.state.region = region;
                localStorage.setItem('kkv_profile', JSON.stringify({name, region}));
                
                document.getElementById('info-name').innerText = name;
                document.getElementById('info-region').innerText = region;
                this.showPage('page-menu');
            },

            logout() {
                localStorage.removeItem('kkv_profile');
                location.reload();
            },

            // --- Check In / Out Logic ---
            goToCheck(status) {
                this.state.currentStatus = status;
                document.getElementById('check-title').innerText = status;
                const fields = document.getElementById('check-fields');
                fields.innerHTML = '';
                
                if(status !== 'Site Check In') {
                    fields.innerHTML = `
                        <input type="text" id="f-buddy" class="input-field" placeholder="ทำงานร่วมกับใคร">
                        <input type="text" id="f-car" class="input-field" placeholder="ใช้รถใคร">
                        <input type="number" id="f-mile" class="input-field" placeholder="เลขไมล์">
                        <input type="text" id="f-place" class="input-field" placeholder="สถานที่ ${status}">
                        <textarea id="f-plan" class="input-field h-24" placeholder="${status === 'Check In' ? 'PLAN: แผนงานวันนี้' : 'BRIEF: สรุปงานวันนี้'}"></textarea>
                    `;
                }
                this.showPage('page-check-form');
            },

            previewImage(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById('img-preview');
                        img.src = e.target.result;
                        img.classList.remove('hidden');
                        this.state.photo = e.target.result;
                        document.getElementById('btn-submit-check').classList.remove('hidden');
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            getLocation() {
                const status = document.getElementById('gps-status');
                status.innerText = "กำลังเข้าถึงพิกัด...";
                navigator.geolocation.getCurrentPosition(
                    p => {
                        this.state.lat = p.coords.latitude;
                        this.state.lng = p.coords.longitude;
                        status.innerText = `พิกัดปัจจุบัน: ${this.state.lat.toFixed(5)}, ${this.state.lng.toFixed(5)}`;
                    },
                    e => { status.innerText = "ไม่พบพิกัด กรุณาเปิด GPS"; }
                );
            },

            submitCheck() {
                const data = {
                    nickname: this.state.user,
                    region: this.state.region,
                    status: this.state.currentStatus,
                    photoData: this.state.photo,
                    geoStamp: `${this.state.lat},${this.state.lng}`,
                    buddy: document.getElementById('f-buddy')?.value || '',
                    car: document.getElementById('f-car')?.value || '',
                    mileage: document.getElementById('f-mile')?.value || '',
                    place: document.getElementById('f-place')?.value || '',
                    plan: document.getElementById('f-plan')?.value || '',
                    device: /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'PC'
                };
                
                // Show Loader
                document.getElementById('btn-submit-check').innerText = "กำลังบันทึก...";
                google.script.run.withSuccessHandler(() => {
                    const alertBox = document.getElementById('safety-alert');
                    (this.state.currentStatus.includes('Check In')) ? alertBox.classList.remove('hidden') : alertBox.classList.add('hidden');
                    this.showPage('page-success');
                }).processForm(data);
            },

            // --- Report Logic ---
            goToReport() {
                this.state.currentStatus = 'Report';
                this.renderReportStep1();
                this.showPage('page-report');
            },

            renderReportStep1() {
                const container = document.getElementById('report-container');
                container.innerHTML = `
                    <div>
                        <label class="text-sm font-bold">บัดดี้ (ชื่อเล่น)</label>
                        <input type="text" id="r-buddy" class="input-field mt-1" placeholder="ต้องเหมือนเดิมทุกครั้ง">
                    </div>
                    <div>
                        <label class="text-sm font-bold">รายงานผลของวันที่</label>
                        <input type="date" id="r-date" class="input-field mt-1">
                    </div>
                    <div>
                        <label class="text-sm font-bold">ประเภทงาน</label>
                        <select id="r-jobtype" class="input-field mt-1" onchange="app.state.currentJobType = this.value">
                            <option value="งาน CR">งาน CR</option>
                            <option value="งาน OFFICE">งาน OFFICE</option>
                            <option value="งาน TE">งาน TE</option>
                            <option value="งาน DRONE">งาน DRONE</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <textarea id="r-detail" class="input-field h-24" placeholder="ระบุรายละเอียดงาน"></textarea>
                `;
                document.getElementById('report-footer').innerHTML = `<button onclick="app.submitReportInit()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">ถัดไป</button>`;
            },

            submitReportInit() {
                if(this.state.currentJobType === 'งาน CR') {
                    this.renderReportSite(1);
                } else {
                    // Submit direct
                    this.showPage('page-success');
                }
            },

            renderReportSite(num) {
                const container = document.getElementById('report-container');
                container.innerHTML = `
                    <h3 class="font-bold text-blue-500 underline">ข้อมูลไซต์ที่ ${num}</h3>
                    <select id="rs-region" class="input-field"><option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option></select>
                    <input type="text" id="rs-name" class="input-field" placeholder="ชื่อไซต์">
                    <input type="text" id="rs-prov" class="input-field" placeholder="จังหวัด">
                    <select id="rs-work" class="input-field">
                        <option>ไม่ได้ลงพื้นที่ โทรติดต่อนัดประชาคม</option>
                        <option>ลงพื้นที่ทำ CR - CRL</option>
                        <option>ลงพื้นที่ทำ CR + นัดประชาคม</option>
                        <option>ลงพื้นที่ ทำประชาคม</option>
                        <option>อื่นๆ</option>
                    </select>
                    <textarea id="rs-detail" class="input-field" placeholder="รายละเอียดงาน"></textarea>
                    <input type="text" id="rs-ld" class="input-field" placeholder="ชื่อผู้นำ-เบอร์โทร">
                    <div class="bg-gray-100 p-3 rounded-lg">
                        <label class="text-sm">มีไซต์ที่ ${num+1} หรือไม่?</label>
                        <select id="rs-next" class="input-field mt-1">
                            <option value="no">ไม่มี / ส่งรายงาน</option>
                            <option value="yes">มีไซต์ที่ ${num+1}</option>
                        </select>
                    </div>
                `;
                document.getElementById('report-footer').innerHTML = `
                    <button onclick="app.handleNextSite(${num})" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">บันทึกและไปต่อ</button>
                `;
            },

            handleNextSite(num) {
                const hasNext = document.getElementById('rs-next').value;
                if(hasNext === 'yes' && num < 4) {
                    this.renderReportSite(num + 1);
                } else {
                    this.showPage('page-success');
                }
            },

            // --- Capture Logic ---
            goToCapture() {
                const select = document.getElementById('cap-date-select');
                select.innerHTML = '';
                for(let i=0; i<8; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const ds = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
                    select.innerHTML += `<option value="${ds}">${ds}</option>`;
                }
                this.showPage('page-capture');
                this.fetchReportData();
            },

            fetchReportData() {
                const targetDate = document.getElementById('cap-date-select').value;
                const resultDiv = document.getElementById('cap-result');
                resultDiv.innerHTML = '<div class="text-center p-10 text-gray-400">กำลังดึงข้อมูล...</div>';
                
                google.script.run.withSuccessHandler(data => {
                    if(data.length === 0) {
                        resultDiv.innerHTML = '<p class="text-center text-red-400 py-10">ไม่พบข้อมูลของวันนี้</p>';
                        return;
                    }
                    resultDiv.innerHTML = data.map(row => `
                        <div class="card border-l-4 border-blue-500 text-sm">
                            <div class="flex justify-between font-bold text-gray-700">
                                <span><i class="fas fa-clock mr-1 text-gray-400"></i>${row[1]}</span>
                                <span class="text-blue-600">${row[4]}</span>
                            </div>
                            <p class="mt-2"><b>ผู้บันทึก:</b> ${row[2]} (${row[3]})</p>
                            <p><b>สถานที่:</b> ${row[13] || '-'}</p>
                            <p class="text-gray-500 italic mt-1">"${row[14] || '-'}"</p>
                        </div>
                    `).join('');
                }).getReportData(targetDate);
            }
        };

        // Initialize user profile
        window.onload = () => {
            const saved = localStorage.getItem('kkv_profile');
            if(saved) {
                const p = JSON.parse(saved);
                document.getElementById('setup-name').value = p.name;
                document.getElementById('setup-region').value = p.region;
                app.saveSetup();
            }
        };
    </script>
</body>
</html>
