<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 AEC Report - KKV01</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f1f5f9; }
        .step-content { display: none; }
        .step-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 24px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .btn-menu { transition: all 0.2s; border-radius: 18px; }
        .btn-menu:active { transform: scale(0.95); }
        input, select, textarea { border-radius: 12px !important; }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div class="bg-slate-900 text-white p-8 rounded-b-[3rem] shadow-2xl mb-6 text-center border-b-4 border-blue-500">
        <h1 class="text-3xl font-extrabold tracking-tight">2026 AEC REPORT</h1>
        <div class="flex justify-center items-center mt-2 space-x-2">
            <span class="bg-blue-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Project KKV01</span>
        </div>
    </div>

    <div class="max-w-md mx-auto px-4">

        <div id="page-setup" class="step-content active">
            <div class="glass-card p-6 border border-white">
                <h2 class="text-xl font-bold mb-5 flex items-center text-slate-700">
                    <i class="fas fa-id-badge mr-3 text-blue-600"></i>ข้อมูลพื้นฐาน
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-semibold text-slate-500 ml-1">ชื่อเล่น (Name)</label>
                        <input type="text" id="setup-name" class="w-full p-4 mt-1 bg-slate-50 border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="กรอกชื่อเล่น">
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-500 ml-1">ภาคที่สังกัด (Region)</label>
                        <select id="setup-region" class="w-full p-4 mt-1 bg-slate-50 border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">เลือกภาค...</option>
                            <option value="BKK">BKK</option><option value="CR">CR</option><option value="ER">ER</option>
                            <option value="NER">NER</option><option value="NR">NR</option><option value="SR">SR</option>
                            <option value="TE">TE</option><option value="DR">DR</option><option value="OFFICE">OFFICE</option>
                        </select>
                    </div>
                    <button onclick="app.saveProfile()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 btn-menu">
                        บันทึกและเริ่มงาน
                    </button>
                </div>
            </div>
        </div>

        <div id="page-menu" class="step-content">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="app.openCheck('Site Check In')" class="btn-menu glass-card p-6 flex flex-col items-center border-b-4 border-emerald-500">
                    <div class="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-map-marker-alt text-2xl text-emerald-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Site Check In</span>
                </button>
                <button onclick="app.openCheck('Check In')" class="btn-menu glass-card p-6 flex flex-col items-center border-b-4 border-blue-500">
                    <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-sign-in-alt text-2xl text-blue-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Check In</span>
                </button>
                <button onclick="app.openCheck('Check Out')" class="btn-menu glass-card p-6 flex flex-col items-center border-b-4 border-red-400">
                    <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-sign-out-alt text-2xl text-red-500"></i>
                    </div>
                    <span class="font-bold text-slate-700">Check Out</span>
                </button>
                <button onclick="app.openReport()" class="btn-menu glass-card p-6 flex flex-col items-center border-b-4 border-amber-500">
                    <div class="w-14 h-14 bg-amber-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-file-alt text-2xl text-amber-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Report</span>
                </button>
                <button onclick="app.openExpenses()" class="btn-menu glass-card p-6 flex flex-col items-center border-b-4 border-purple-500">
                    <div class="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-wallet text-2xl text-purple-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Expenses</span>
                </button>
                <button onclick="app.openCapture()" class="btn-menu glass-card p-6 flex flex-col items-center border-b-4 border-pink-500">
                    <div class="w-14 h-14 bg-pink-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-camera-retro text-2xl text-pink-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Capture</span>
                </button>
            </div>
            <div class="mt-8 text-center bg-white/50 p-4 rounded-2xl border border-dashed border-slate-300">
                <p class="text-sm text-slate-500">User: <span id="user-display" class="font-bold text-slate-800"></span></p>
                <button onclick="app.logout()" class="text-xs text-red-400 font-bold uppercase mt-1 tracking-widest">Logout</button>
            </div>
        </div>

        <div id="page-check-form" class="step-content">
            <div class="glass-card p-6">
                <h2 id="check-title" class="text-xl font-bold mb-6 text-slate-800 border-l-4 border-blue-500 pl-3 uppercase"></h2>
                
                <div class="space-y-4" id="check-fields-container">
                    </div>

                <div class="mt-6">
                    <div class="relative w-full h-48 bg-slate-100 rounded-2xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center overflow-hidden">
                        <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="app.handlePhoto(this)">
                        <label for="photo-input" class="cursor-pointer text-center p-4">
                            <i class="fas fa-cloud-upload-alt text-4xl text-slate-400"></i>
                            <p class="text-sm text-slate-500 mt-2">ถ่ายภาพ หรือ เลือกรูป</p>
                        </label>
                        <img id="img-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                </div>

                <div id="location-info" class="mt-4 p-4 bg-blue-50 rounded-xl flex items-start space-x-3">
                    <i class="fas fa-map-marked-alt text-blue-500 mt-1"></i>
                    <div class="text-xs text-blue-700">
                        <b>พิกัด GPS:</b> <span id="gps-display">ยังไม่พบข้อมูล...</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="app.getGPS()" class="bg-slate-200 text-slate-700 font-bold py-4 rounded-xl">ดึงพิกัด</button>
                    <button id="btn-submit-check" onclick="app.submitCheck()" class="bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg opacity-50 pointer-events-none">ส่งข้อมูล</button>
                </div>
                <button onclick="app.showPage('page-menu')" class="w-full text-slate-400 text-sm mt-5">ย้อนกลับ</button>
            </div>
        </div>

        <div id="page-success" class="step-content text-center">
            <div class="glass-card p-10">
                <div class="w-24 h-24 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i class="fas fa-check text-5xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">บันทึกข้อมูลสำเร็จ!</h2>
                <p class="text-slate-500 mt-2 italic">ขอขอบคุณที่เป็นส่วนหนึ่งในภารกิจวันนี้</p>
                
                <div id="safety-banner" class="hidden mt-8 p-5 bg-red-600 text-white rounded-3xl shadow-xl shadow-red-200 animate-pulse">
                    <i class="fas fa-hard-hat text-3xl mb-2"></i>
                    <h3 class="font-black text-xl">SAFETY FIRST!</h3>
                    <p class="text-xs opacity-90">อุบัติเหตุเป็นศูนย์ เริ่มต้นที่วินัยการทำงาน</p>
                </div>

                <button onclick="app.showPage('page-menu')" class="mt-10 bg-blue-600 text-white px-12 py-4 rounded-full font-bold shadow-lg shadow-blue-200 uppercase tracking-widest">เมนูหลัก</button>
            </div>
        </div>

    </div>

    <script>
        // ใส่ URL App Script ของคุณที่นี่
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9rkPkGPIeGpvRaOfeaBTvoINTFWObFMAqkAyvxBqv3sP14c_5cVf-vFRaAhVNDXJE/exec';

        const app = {
            state: { name: '', region: '', currentType: '', photo: '', lat: '', lng: '' },

            showPage(id) {
                document.querySelectorAll('.step-content').forEach(p => p.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                window.scrollTo(0,0);
            },

            saveProfile() {
                const n = document.getElementById('setup-name').value;
                const r = document.getElementById('setup-region').value;
                if(!n || !r) return alert('กรุณาระบุข้อมูลให้ครบถ้วน');
                this.state.name = n;
                this.state.region = r;
                localStorage.setItem('kkv_profile', JSON.stringify({n, r}));
                document.getElementById('user-display').innerText = `${n} (${r})`;
                this.showPage('page-menu');
            },

            logout() {
                localStorage.removeItem('kkv_profile');
                location.reload();
            },

            openCheck(type) {
                this.state.currentType = type;
                document.getElementById('check-title').innerText = type;
                const container = document.getElementById('check-fields-container');
                container.innerHTML = '';
                this.state.photo = '';
                document.getElementById('img-preview').classList.add('hidden');
                document.getElementById('btn-submit-check').classList.add('opacity-50', 'pointer-events-none');

                if(type !== 'Site Check In') {
                    container.innerHTML = `
                        <input type="text" id="f-buddy" class="w-full p-4 bg-slate-50 border-0 ring-1 ring-slate-200 outline-none focus:ring-2 focus:ring-blue-500" placeholder="ทำงานร่วมกับใคร (Buddy)">
                        <input type="text" id="f-car" class="w-full p-4 bg-slate-50 border-0 ring-1 ring-slate-200 outline-none focus:ring-2 focus:ring-blue-500" placeholder="ใช้รถคันไหน">
                        <input type="number" id="f-mile" class="w-full p-4 bg-slate-50 border-0 ring-1 ring-slate-200 outline-none focus:ring-2 focus:ring-blue-500" placeholder="เลขไมล์ปัจจุบัน">
                        <input type="text" id="f-place" class="w-full p-4 bg-slate-50 border-0 ring-1 ring-slate-200 outline-none focus:ring-2 focus:ring-blue-500" placeholder="สถานที่เช็คอิน/เช็คเอาท์">
                        <textarea id="f-plan" class="w-full p-4 h-24 bg-slate-50 border-0 ring-1 ring-slate-200 outline-none focus:ring-2 focus:ring-blue-500" placeholder="${type === 'Check In' ? 'ระบุแผนงาน (PLAN)' : 'ระบุสรุปงาน (BRIEF)'}"></textarea>
                    `;
                }
                this.showPage('page-check-form');
            },

            handlePhoto(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.state.photo = e.target.result;
                        const preview = document.getElementById('img-preview');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        this.checkReady();
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            getGPS() {
                const disp = document.getElementById('gps-display');
                disp.innerText = 'กำลังค้นหาสัญญาณ...';
                navigator.geolocation.getCurrentPosition(
                    p => {
                        this.state.lat = p.coords.latitude;
                        this.state.lng = p.coords.longitude;
                        disp.innerText = `${this.state.lat.toFixed(5)}, ${this.state.lng.toFixed(5)}`;
                        this.checkReady();
                    },
                    err => { disp.innerText = 'เกิดข้อผิดพลาดในการดึงพิกัด'; }
                );
            },

            checkReady() {
                if(this.state.photo && this.state.lat) {
                    const btn = document.getElementById('btn-submit-check');
                    btn.classList.remove('opacity-50', 'pointer-events-none');
                }
            },

            submitCheck() {
                const btn = document.getElementById('btn-submit-check');
                btn.innerText = 'กำลังส่งข้อมูล...';
                btn.classList.add('opacity-50', 'pointer-events-none');

                const data = {
                    nickname: this.state.name,
                    region: this.state.region,
                    status: this.state.currentType,
                    photoData: this.state.photo,
                    geoStamp: `${this.state.lat},${this.state.lng}`,
                    buddy: document.getElementById('f-buddy')?.value || '',
                    car: document.getElementById('f-car')?.value || '',
                    mileage: document.getElementById('f-mile')?.value || '',
                    place: document.getElementById('f-place')?.value || '',
                    plan: document.getElementById('f-plan')?.value || '',
                    device: 'Mobile-Web-Github'
                };

                // ส่งข้อมูลไปที่ Apps Script ผ่าน Fetch
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(data)
                }).then(() => {
                    const banner = document.getElementById('safety-banner');
                    (this.state.currentType.includes('Check In')) ? banner.classList.remove('hidden') : banner.classList.add('hidden');
                    this.showPage('page-success');
                    btn.innerText = 'ส่งข้อมูล';
                }).catch(e => {
                    alert('ส่งข้อมูลไม่สำเร็จ กรุณาลองใหม่');
                    btn.classList.remove('opacity-50', 'pointer-events-none');
                    btn.innerText = 'ส่งข้อมูล';
                });
            }
        };

        // Auto-login
        window.onload = () => {
            const saved = localStorage.getItem('kkv_profile');
            if(saved) {
                const data = JSON.parse(saved);
                document.getElementById('setup-name').value = data.n;
                document.getElementById('setup-region').value = data.r;
                app.saveProfile();
            }
        };
    </script>
</body>
</html>
